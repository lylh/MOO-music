<template>
  <Navbar
    title="🎵 登录"
    left-arrow
  />

  <!-- #ifdef H5 -->
  <H5BackTransition
    :ref="(el: any) => el?.open()"
    class="relative w-full !h-4/5"
  >
    <!-- #endif -->
    <view class="z-50 mid">
      <!-- 二维码登录区域 -->
      <view v-if="!showManualLogin">
        <JImage
          :src="qrimg"
          width="400rpx"
          height="400rpx"
        />

        <button
          class="font-bold bg-yellow-1 text-black-1 rounded-full my-4"
          :loading="isLoading"
          @tap.stop="toNetease"
        >
          {{ qrimg ? '打开网易云音乐' : '获取二维码中...' }}
        </button>

        <uni-notice-bar
          v-if="qrimg"
          class="rounded-md overflow-hidden"
          show-icon
          text="请手动截图保存后,点击按钮跳转网易云音乐进行扫码（**小程序不支持跳转**）"
        />

        <!-- 切换到手动登录 -->
        <button
          class="font-bold bg-gray-500 text-white rounded-full mt-4 text-sm"
          @tap="showManualLogin = true"
        >
          手动输入Cookie登录
        </button>
      </view>

      <!-- 手动Cookie登录区域 -->
      <view v-else class="w-full px-8">
        <view class="text-center mb-6">
          <text class="text-lg font-bold">🍪 手动Cookie登录</text>
        </view>

        <textarea
          v-model="manualCookie"
          class="w-full h-32 p-4 border border-gray-300 rounded-lg text-sm"
          placeholder="请粘贴从浏览器获取的完整Cookie..."
          :maxlength="2000"
        />

        <view class="flex gap-2 mt-4">
          <button
            class="flex-1 font-bold bg-green-500 text-white rounded-full"
            :loading="isManualLoading"
            @tap="handleManualLogin"
          >
            确认登录
          </button>
          <button
            class="flex-1 font-bold bg-gray-500 text-white rounded-full"
            @tap="showManualLogin = false"
          >
            返回扫码
          </button>
        </view>

        <button
          class="w-full font-bold bg-blue-500 text-white rounded-full mt-2 text-sm"
          @tap="showCookieHelp"
        >
          如何获取Cookie？
        </button>

        <uni-notice-bar
          class="rounded-md overflow-hidden mt-4"
          show-icon
          text="Cookie包含敏感信息，请确保来源安全可靠"
        />
      </view>
    </view>
  <!-- #ifdef H5 -->
  </H5BackTransition>
  <!-- #endif -->
</template>

<script setup lang="ts">
import { createQRKey, createQRImg, checkQRStatus } from '@/api/login'
import { setManualCookie, getCookieInstructions } from '@/utils/cookieHelper'
import toast from '@/utils/toast'

const qrimg = ref('')
const isLoading = ref(false)

// 手动Cookie登录相关
const showManualLogin = ref(false)
const manualCookie = ref('')
const isManualLoading = ref(false)

let timer: number | undefined
onBeforeUnmount(() => { timer && clearInterval(timer) })

login()

// 手动Cookie登录处理
async function handleManualLogin() {
  if (!manualCookie.value.trim()) {
    toast.fail('请输入Cookie')
    return
  }

  isManualLoading.value = true
  
  try {
    const success = await setManualCookie(manualCookie.value.trim())
    if (success) {
      // 登录成功，清理定时器
      if (timer) {
        clearInterval(timer)
        timer = undefined
      }
    }
  } catch (error) {
    console.error('手动登录失败:', error)
  } finally {
    isManualLoading.value = false
  }
}

// 显示Cookie获取帮助
function showCookieHelp() {
  const instructions = getCookieInstructions()
  
  uni.showModal({
    title: '获取Cookie指南',
    content: instructions,
    showCancel: false,
    confirmText: '我知道了'
  })
}

async function login() {
  isLoading.value = true

  const { data: { unikey }} = await createQRKey()
  console.log('🚀 ~ file: index.vue:73 ~ qr/key ~ :', unikey)
  const { data: { qrimg: _qrimg }} = await createQRImg(unikey)
  qrimg.value = _qrimg

  timer = setInterval(async() => {
    const { code, cookie } = await checkQRStatus(unikey)
    console.log('🚀 ~ file: login.vue:54 ~ timer=setInterval ~ checkQRStatus:', { code, cookie })

    switch (code) {
      case 800: {
        toast.fail('二维码已过期,请重新获取')
        clearInterval(timer)
        isLoading.value = false
        qrimg.value = ''
        break
      }
      case 803: { // * 这一步会返回cookie
        clearInterval(timer)

        // ! 截取需要的“cookie”小程序端不会自动发送cookie  ps: cookie是以分号加空格进行分割的
        const cookies = cookie.match(/MUSIC_U=?\w+\;/)![0] + ' ' + cookie.match(/__csrf=?\w+\;/)![0]
        console.log('🚀 ~ file: login.vue:80 ~ cookies:', cookies)

        setupLogin(cookie) // ! 执行登录
        uni.setStorage({ key: 'cookie', data: cookies })
        uni.reLaunch({ url: '/pages/index/index' })
        break
      }
    }
  }, 3000)
}

function toNetease() {
  // #ifdef H5
  H5ToNetease()
  // #endif

  // #ifdef APP-PLUS
  APPToNetease()
  // #endif

  // ! 小程序跳不了...
}

// #ifdef H5
function H5ToNetease() {
  // * 提前创建一个定时器作为结果预测提示
  const timer = setTimeout(() => {
    console.error('跳转失败。。。')
    toast.fail('如果跳转失败请手动打开')
  }, 3000)

  // * 添加一个“visibilitychange”事件用于判断是否发生了跳转
  document.addEventListener('visibilitychange', onChange)
  function onChange() {
    if (document.hidden) {
      console.log('跳转APP')
      clearTimeout(timer)
      document.removeEventListener('visibilitychange', onChange)
    }
  }

  // * 跳转APP
  window.location.href = 'orpheus://'
}
// #endif

// #ifdef APP-PLUS
function APPToNetease() {
  const scheme = 'orpheuswidget://'
  const packageName = 'com.netease.cloudmusic'

  if (!plus.runtime.isApplicationExist({ action: scheme, pname: packageName })) {
    console.error('网易云音乐APP未安装')
    toast.fail('请安装网易云音乐')
    return
  }

  function error(e: any) {
    console.error('打开网易云音乐失败: ' + e.message)
    toast.fail('打开网易云音乐失败, 请自行启动')
  }

  if (plus.os.name === 'Android') {
    plus.runtime.launchApplication({ pname: packageName }, error)
  } else if (plus.os.name === 'iOS') {
    plus.runtime.launchApplication({ action: scheme }, error)
  }
}
// #endif
</script>
